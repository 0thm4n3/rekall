
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Rekall Memory Forensic Framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Rekall Memory Forensic Framework">

    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="/css/rekall.css" rel="stylesheet">
    <link href="/css/asciidoc.css" rel="stylesheet">
    <link href="/css/treeview.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></sc\
ript>
    <![endif]-->
  </head>

  <body>



   <nav class="navbar navbar-inverse navbar-fixed-top"
     role="navigation">
     <div class="container-fluid">
       <div class="navbar-header">
         <a class="navbar-brand" href="#">Rekall Memory Forensic Framework</a>
       </div>

       <div class="navbar-collapse collapse">
         <ul class="nav navbar-nav">

        <li>
          <a class="" href="/index.html">
            Home
          </a>
        </li>

        <li>
          <a class="" href="/about.html">
            About
          </a>
        </li>

        <li>
          <a class="" href="/blog.html">
            Blog
          </a>
        </li>

        <li>
          <a class="" href="/docs.html">
            Documentation
          </a>
        </li>

        <li>
          <a class="" href="/downloads.html">
            Downloads
          </a>
        </li>

        <li>
          <a class="" href="/faq.html">
            FAQ
          </a>
        </li>

         </ul>
         <form class="navbar-form navbar-right" role="search" action="/search.html">
           <div class="form-group">
             <input type="text" name="q" class="form-control" placeholder="Site Search">
           </div>
           <button type="submit" class="btn btn-default">
             <span class="glyphicon glyphicon-search"></span>
           </button>
         </form>
       </div> <!-- navbar-collapse -->
     </div> <!-- container-fluid -->
   </nav>

<div class="container-fluid">
<div class="row">
  <div class="col-md-2">
    
  </div>

  <div class="col-md-8">
    
<div id="header">
</div>
<div id="content">
<div class="paragraph"><p>New Rekall Plugin: Mac Compressed Memory</p></div>
<div class="exampleblock">
<div class="content">
<div class="paragraph"><p>Beginning of August I went to the DFRWS US conference in Denver. There were lots of very interesting talks on forensics presented at that conference but I found one of them particularly interesting. The title of the presented paper was "In Lieu of Swap: Analyzing Compressed RAM in Mac OS X and Linux" (Golden G. Richard III and Andrew Case) [<a href="http://dfrws.org/2014/proceedings/DFRWS2014-1.pdf">1</a>]. The conference organizers found this paper really good too, it won this years Best Paper Award.</p></div>
<div class="paragraph"><p>In the talk, one of the authors presented how they are able to extract Mac compressed memory from an image. Since OS X Mavericks, Macs can compress memory regions that are not currently used to save some space [<a href="https://www.apple.com/osx/advanced-technologies/">2</a>]. This obviously poses some problems for memory forensics since for example simple string matching won&#8217;t work anymore if the memory you are looking at was compressed.</p></div>
<div class="paragraph"><p>In the presentation, one of the authors introduced their approach to find and decompress those memory regions (they implemented a Volatility plugin which does it). I became particularly interested when I heard that he was complaining that the Python implementation of the decompression algorithm they have is very slow. I really wanted to analyze what they have done and if there is a way of improving the speed of this algorithm but unfortunately I found out that the authors have not released the code for this yet. Even now, one month later, the code is nowhere to be found :( I thought this might be an
interesting challenge though so that same evening after coming back from conference beers I sat down and implemented my own version of the decompressor.</p></div>
<div class="paragraph"><p>To compress memory, Apple uses an algorithm called WKdm which was published in 1997 by Paul Wilson and Scott F. Kaplan (with slight modifications). There is a standard C implementation freely available (for example found in this repository [<a href="https://github.com/santolucito/CCache/tree/master/WKdm">3</a>]) but no Python one as far as I know. Apple uses a highly optimized assembler version for Mavericks which is way faster than the C implementation.</p></div>
<div class="paragraph"><p>I ported the code from [<a href="https://github.com/santolucito/CCache/tree/master/WKdm">3</a>] basically 1:1 to Python and quickly saw why the Python version is slow. There are lots of bit operations that Python is particularly bad at and also many of the operations are vectorized in C which is not so easily done in Python. I spent some time optimizing this using some precomputations and use of Python iterators as pointers and actually got acceptable performance for this algorithm. My implementation can now do 1000 compress/decompress operations of a 4k page per second on my 2014 Macbook Pro 15 inch which is 2.5 times as much as what was claimed in the talk for the implementation they had. Of course I am fully aware that I&#8217;m comparing apples and oranges here since the hardware they used was probably completely different. However, they still have not released the code they were talking about so I have no way of staging a fair comparison. Regardless of the performance difference, this was a fun exercise. If you want to take a look at my optimized implementation, it&#8217;s available in the Rekall repository [<a href="https://github.com/google/rekall/blob/master/rekall/plugins/darwin/WKdm.py">4</a>].</p></div>
<div class="paragraph"><p>As a side effect of having this memory decompressor, I was also able
to implement a Rekall plugin that dumps all compressed memory pages in
a Darwin image to disk, it&#8217;s called "dumpcompressedmemory":</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>rekal -f ~/mem.dump

&lt;...&gt;
mem.dump 14:03:46&gt; mkdir /tmp/compressed_memory
mem.dump 14:03:54&gt; dumpcompressedmemory(dump_dir="/tmp/compressed_memory/")
&lt;...&gt;

mem.dump 14:04:03&gt; ls /tmp/compressed_memory/
segment0/ segment1/ segment10/
&lt;...&gt;

mem.dump 14:04:08&gt; ls /tmp/compressed_memory/segment1
slot1.dmp slot16.dmp slot23.dmp slot29.dmp slot34.dmp slot43.dmp
slot10.dmp slot17.dmp slot24.dmp slot3.dmp slot35.dmp
&lt;...&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>[1] <a href="http://dfrws.org/2014/proceedings/DFRWS2014-1.pdf">http://dfrws.org/2014/proceedings/DFRWS2014-1.pdf</a></p></div>
<div class="paragraph"><p>[2] <a href="https://www.apple.com/osx/advanced-technologies/">https://www.apple.com/osx/advanced-technologies/</a></p></div>
<div class="paragraph"><p>[3] <a href="https://github.com/santolucito/CCache/tree/master/WKdm">https://github.com/santolucito/CCache/tree/master/WKdm</a></p></div>
<div class="paragraph"><p>[4] <a href="https://github.com/google/rekall/blob/master/rekall/plugins/darwin/WKdm.py">https://github.com/google/rekall/blob/master/rekall/plugins/darwin/WKdm.py</a></p></div>
</div></div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2014-10-04 14:37:12 CEST
</div>
</div>
<script src="/js/asciidoc.js"></script>
  </div>
  <div class="col-md-2 sidebar">
    <img src="/img/Rekall.png" class="logo"></img>


  </div>
</div>
</div>
  <script>
   $(".activate_tooltip").tooltip();
  </script>
  </body>
</html>

