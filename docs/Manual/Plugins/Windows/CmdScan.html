
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Rekall Memory Forensic Framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Rekall Memory Forensic Framework">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/rekall.css" rel="stylesheet">
    <link href="/css/asciidoc.css" rel="stylesheet">
    <link href="/css/font-awesome.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></sc\
ript>
    <![endif]-->
  </head>

  <body>


  <div class="background">
   <header class="header">
    <div class="navbar navbar-fixed-top navbar-inverse">
     <div class="navbar-inner">
      <div class="container">
       <a class="navbar-brand" href="/"
          style="padding-top: 0px; padding-bottom: 0px;"
          >
          <img src="/img/Rekall-small.png" class="small_logo"></img>
       </a>
       <ul class="nav navbar-nav navbar-collapse collapse">

        <li class="divider-vertical"></li>
        
    <li class="">
     <a href="/index.html">
      Home
     </a>
    </li>
    
        <li class="divider-vertical"></li>
        
    <li class="">
     <a href="/about.html">
      About
     </a>
    </li>
    
        <li class="divider-vertical"></li>
        
    <li class=" dropdown">
     <a class="dropdown-toggle"
      id="dropdownMenuReleases"
      data-toggle="dropdown"
      aria-expanded="true">
    Releases
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuReleases">

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Releases/releases-1.2.1.html">Version 1.2.1 Col de la Croix.</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Releases/releases-1.3.1.html">Version 1.3.1 Dammastock.</a></li>

  </ul>
 </li>

        <li class="divider-vertical"></li>
        
    <li class=" dropdown">
     <a class="dropdown-toggle"
      id="dropdownMenuDocumentation"
      data-toggle="dropdown"
      aria-expanded="true">
    Documentation
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuDocumentation">

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/Manual">Rekall User Manual</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/Developers">Developer Documentation.</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/GUI">Rekall GUI</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/MemoryAnalysis.html">Memory Analysis Course</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/References">References</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/Tools">The Pmem Memory acquisition suite.</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/docs/index.html"></a></li>

  </ul>
 </li>

        <li class="divider-vertical"></li>
        
    <li class=" dropdown">
     <a class="dropdown-toggle"
      id="dropdownMenuDiscuss"
      data-toggle="dropdown"
      aria-expanded="true">
    Discuss
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenuDiscuss">

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Discuss/blog.html">The Rekall Blog</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Discuss/github.html">GitHub</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Discuss/index.html"></a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Discuss/issue.html">Issue Tracker</a></li>

    <li role="presentation"><a role="menuitem" tabindex="-1" href="/Discuss/mailinglist.html">Mailing List</a></li>

  </ul>
 </li>

        <li class="divider-vertical"></li>
        
    <li class="">
     <a href="/faq.html">
      FAQ
     </a>
    </li>
    
       <li>
        <a href="https://github.com/google/rekall/edit/gh-pages/docs/Manual/Plugins/Windows/CmdScan.md?message=Describe%20your%20change..."
           data-toggle="tooltip"
           data-placement="bottom"
           title="Improve this page"
           class="improve-docs activate_tooltip">
         <i class="glyphicon glyphicon-edit"></i>
        </a>
       </ul>

       <form class="navbar-search col-md-3 docs-search" role="search"
             action="/search.html">
       <span class="glyphicon glyphicon-search search-icon"></span>
       <input type="text" name="q" data-i-search-input="true"
         class="search-query"
         placeholder="Site Search">
       </form>
      </div>
     </div>
    </div>
   </header>

<div class="container-fluid page-background container">
<div class="main">
  <div class="col-md-2">
    
 <a href="/docs/Manual/Plugins/index.html" class="btn btn-default btn-lg btn-block">
  <span class="glyphicon glyphicon-arrow-left"></span> Plugins
 </a>

 <a href='/docs/Manual/Plugins/Windows/index.html' class="btn btn-default btn-lg btn-block">
   Windows
 </a>
 <p>

 <ul class='nav nav-pills nav-stacked'><ul class='nav nav-pills nav-stacked'><li>
          <a href='/docs/Manual/Plugins/Windows/PEAddressResolver.html' class="category-link">
            address_resolver
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WindowsAddressResolver.html' class="category-link">
            address_resolver
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/AnalyzeStruct.html' class="category-link">
            analyze_struct
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Callbacks.html' class="category-link">
            callbacks
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/SetProcessContext.html' class="category-link">
            cc
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/CertVadScan.html' class="category-link">
            cert_vad_scan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/CertScan.html' class="category-link">
            certscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/CheckPEHooks.html' class="category-link">
            check_pehooks
          </a>
        </li>
        <li class='active'>
          <a href='/docs/Manual/Plugins/Windows/CmdScan.html' class="category-link">
            cmdscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Connections.html' class="category-link">
            connections
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ConnScan.html' class="category-link">
            connscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Consoles.html' class="category-link">
            consoles
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DeviceTree.html' class="category-link">
            devicetree
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Disassemble.html' class="category-link">
            dis
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DLLDump.html' class="category-link">
            dlldump
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinDllList.html' class="category-link">
            dlllist
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DriverIrp.html' class="category-link">
            driverirp
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DriverScan.html' class="category-link">
            driverscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DTBScan.html' class="category-link">
            dtbscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DTBScan2.html' class="category-link">
            dtbscan2
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/DumpFiles.html' class="category-link">
            dumpfiles
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/EvtLogs.html' class="category-link">
            evtlogs
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/FileScan.html' class="category-link">
            filescan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinFindDTB.html' class="category-link">
            find_dtb
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/FLS.html' class="category-link">
            fls
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Handles.html' class="category-link">
            handles
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/EATHooks.html' class="category-link">
            hooks_eat
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/IATHooks.html' class="category-link">
            hooks_iat
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/InlineHooks.html' class="category-link">
            hooks_inline
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ImageInfo.html' class="category-link">
            imageinfo
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ImpScan.html' class="category-link">
            impscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/KDBGScan.html' class="category-link">
            kdbgscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/KPCR.html' class="category-link">
            kpcr
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/LdrModules.html' class="category-link">
            ldrmodules
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Malfind.html' class="category-link">
            malfind
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinMemDump.html' class="category-link">
            memdump
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinMemMap.html' class="category-link">
            memmap
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ModDump.html' class="category-link">
            moddump
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ModScan.html' class="category-link">
            modscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Modules.html' class="category-link">
            modules
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/MutantScan.html' class="category-link">
            mutantscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinNetscan.html' class="category-link">
            netscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Netstat.html' class="category-link">
            netstat
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinNetstat.html' class="category-link">
            netstat
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ObjectTree.html' class="category-link">
            object_tree
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Objects.html' class="category-link">
            object_types
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Pagefiles.html' class="category-link">
            pagefiles
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinPas2Vas.html' class="category-link">
            pas2vas
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PEDump.html' class="category-link">
            pedump
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PEInfo.html' class="category-link">
            peinfo
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PFNInfo.html' class="category-link">
            pfn
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinPhysicalMap.html' class="category-link">
            phys_map
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PoolTracker.html' class="category-link">
            pool_tracker
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Pools.html' class="category-link">
            pools
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ProcExeDump.html' class="category-link">
            procdump
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ProcInfo.html' class="category-link">
            procinfo
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinPsList.html' class="category-link">
            pslist
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PSScan.html' class="category-link">
            psscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PSTree.html' class="category-link">
            pstree
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PsXview.html' class="category-link">
            psxview
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WindowsPsxView.html' class="category-link">
            psxview
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PTE.html' class="category-link">
            pte
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/PtoV.html' class="category-link">
            ptov
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Raw2Dump.html' class="category-link">
            raw2dmp
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Services.html' class="category-link">
            services
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Sockets.html' class="category-link">
            sockets
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinSSDT.html' class="category-link">
            ssdt
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/SvcScan.html' class="category-link">
            svcscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/SymLinkScan.html' class="category-link">
            symlinkscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ThrdScan.html' class="category-link">
            thrdscan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Threads.html' class="category-link">
            threads
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Timers.html' class="category-link">
            timers
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/GetSIDs.html' class="category-link">
            tokens
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/UnloadedModules.html' class="category-link">
            unloaded_modules
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/EnumerateVacbs.html' class="category-link">
            vacbs
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VAD.html' class="category-link">
            vad
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VADDump.html' class="category-link">
            vaddump
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VADInfo.html' class="category-link">
            vadinfo
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VADMap.html' class="category-link">
            vadmap
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VADTree.html' class="category-link">
            vadtree
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VADWalk.html' class="category-link">
            vadwalk
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/ModVersions.html' class="category-link">
            version_modules
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinVirtualMap.html' class="category-link">
            virt_map
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/VtoP.html' class="category-link">
            vtop
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Win32kAutodetect.html' class="category-link">
            win32k_autodetect
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/WinYaraScan.html' class="category-link">
            yarascan
          </a>
        </li>
        <li>
          <a href='/docs/Manual/Plugins/Windows/YaraScan.html' class="category-link">
            yarascan
          </a>
        </li>
        </ul>
        <li>
          <a href='/docs/Manual/Plugins/Windows/Registry' class="category-link">
            Registry
          </a>
        </li>
        
        <li>
          <a href='/docs/Manual/Plugins/Windows/Win32_GUI' class="category-link">
            Win32_GUI
          </a>
        </li>
        </ul>


  </div>

  <div class="col-md-10">
    

<nav class="navbar navbar-default plugins" role="navigation">

  <ul class="nav navbar-nav navbar-left">
    <li class="active">
       <a href="/docs/Manual/Plugins/Windows/CheckPEHooks.html">
         <span class="glyphicon glyphicon-arrow-left"></span>
         check_pehooks
       </a>
    </li>
  </ul>


  <ul class="nav navbar-nav navbar-right">
    <li class="active">
       <a href="/docs/Manual/Plugins/Windows/Connections.html">
          connections
          <span class="glyphicon glyphicon-arrow-right"></span>
       </a>
    </li>
  </ul>

</nav>


<h1>cmdscan</h1>

<div class="abstract">
<p>Extract command history by scanning for _COMMAND_HISTORY</p>
</div>


<h3>Plugin Arguments</h3>
<table class='table table-striped table-bordered table-hover'>
<tbody>
<tr><td>max_history</td><td>Value of history buffer size. See HKEY_CURRENT_USER\Console\HistoryBufferSize for default.</td></tr>
</tbody>
</table>



<a href="/epydocs/rekall.plugins.windows.malware.cmdhistory.CmdScan-class.html">View Source</a>


<p>The cmdscan plugin searches the memory of csrss.exe on XP/2003/Vista/2008 and
conhost.exe on Windows 7 for commands that attackers entered through a console
shell (cmd.exe). This is one of the most powerful commands you can use to gain
visibility into an attackers actions on a victim system, whether they opened
cmd.exe through an RDP session or proxied input/output to a command shell from a
networked backdoor.</p>
<p>This plugin finds structures known as <strong>COMMAND_HISTORY</strong> by looking for a known
constant value (<strong>MaxHistory</strong>) and then applying sanity checks. It is important
to note that the <strong>MaxHistory</strong> value can be changed by right clicking in the
top left of a cmd.exe window and going to Properties. The value can also be
changed for all consoles opened by a given user by modifying the registry key
HKCU\Console\HistoryBufferSize. The default is 50 on Windows systems, meaning
the most recent 50 commands are saved. You can tweak it if needed by using the
&ndash;max_history=NUMBER parameter.</p>
<p>The structures used by this plugin are not public (i.e. Microsoft does not
produce PDBs for them), thus they&rsquo;re not available in WinDBG or any other
forensic framework. They were reverse engineered by Michael Ligh from the
conhost.exe and winsrv.dll binaries.</p>
<p>In addition to the commands entered into a shell, this plugin shows:</p>
<ul>
<li>
<p>The name of the console host process (csrss.exe or conhost.exe)</p>
</li>
<li>
<p>The name of the application using the console (whatever process is using cmd.exe)</p>
</li>
<li>
<p>The location of the command history buffers, including the current buffer count, last added command, and last displayed command</p>
</li>
<li>
<p>The application process handle</p>
</li>
</ul>
<p>Due to the scanning technique this plugin uses, it has the capability to find
commands from both active and closed consoles.</p>
<h3>Notes</h3>
<p>This plugin is pretty fragile since it relies on reversed structures in
undocumented code. We are working on improving the situation here but there is a
moderate chance that it will produce no results or garbage results.</p>
<h3>Sample Output</h3>
<p>The following showing an operator using the winpmem acquisition tool to analyse
the live memory of a Windows 7 machine.</p>
<div class="highlight"><pre>win7.elf 22:15:39&gt; cmdscan
-----------------&gt; cmdscan()
**************************************************
CommandProcess: conhost.exe Pid: 2652
CommandHistory: 0x7ea40 Application: cmd.exe Flags: Allocated, Reset
CommandCount: 3 LastAdded: 2 LastDisplayed: 2
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x5c
Cmd    Address     Text
--- -------------- --------------------------------------------------
  0 0x00000005ea70 cd \Users\a\Desktop
  1 0x00000005b920 winpmem_1.1-write.exe -w -l
  2 0x0000000b3e70 vol.exe --profile Win7SP1x64 --file \\.\pmem
 15 0x000000040158
 16 0x00000007d3b0

**************************************************
CommandProcess: conhost.exe Pid: 2652
CommandHistory: 0xb40c0 Application: vol.exe Flags: Allocated
CommandCount: 0 LastAdded: -1 LastDisplayed: -1
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0xd4
Cmd    Address     Text
--- -------------- --------------------------------------------------
  0 0x0000001f77e0
  3 0x000000060ef0
  5 0x0000001f77e0
  8 0x000000060ef0
 10 0x0000001f77e0
 13 0x0000ffd96238
 14 0x00000007ec20
 15 0x0000001f7720
 23 0x0000000610a0
 24 0x0000000974e0
**************************************************
CommandProcess: conhost.exe Pid: 2652
CommandHistory: 0xb4410 Application: vol.exe Flags: Allocated
CommandCount: 0 LastAdded: -1 LastDisplayed: -1
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0xd8
Cmd    Address     Text
--- -------------- --------------------------------------------------
</pre></div>

<p>

<nav class="navbar navbar-default plugins" role="navigation">

  <ul class="nav navbar-nav navbar-left">
    <li class="active">
       <a href="/docs/Manual/Plugins/Windows/CheckPEHooks.html">
         <span class="glyphicon glyphicon-arrow-left"></span>
         check_pehooks
       </a>
    </li>
  </ul>


  <ul class="nav navbar-nav navbar-right">
    <li class="active">
       <a href="/docs/Manual/Plugins/Windows/Connections.html">
          connections
          <span class="glyphicon glyphicon-arrow-right"></span>
       </a>
    </li>
  </ul>

</nav>


  </div>
</div>
</div>
  <div class="footer">
    <div class="container">
      <p class="text-muted">
        &copy; 2015 Google Inc.
        Rekall is licensed under the The GPL License.
        Pmem is licensed under the Apache license.
        <a href="#" class="pull-right text-muted">Back to top</a>
      </p>
    </div>
  </div>

  <script>
   $(".activate_tooltip").tooltip();
  </script>
  </div>
 </body>
</html>

