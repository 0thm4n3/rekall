
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Rekall Memory Forensic Framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Rekall Memory Forensic Framework">

    <link href="/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px;
      }
    </style>
    <link href="/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/css/asciidoc.css" rel="stylesheet">
    <link href="/css/treeview.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></sc\
ript>
    <![endif]-->
  </head>

  <body>


    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="#">Rekall Memory Forensic Framework</a>
          <div class="nav-collapse collapse">
            <ul class="nav">

        <li>
          <a class="" href="/index.html">
            Home
          </a>
        </li>

        <li>
          <a class="" href="/about.html">
            About
          </a>
        </li>

        <li>
          <a class="" href="/blog.html">
            Blog
          </a>
        </li>

        <li>
          <a class="" href="/docs.html">
            Documentation
          </a>
        </li>

        <li>
          <a class="" href="/downloads.html">
            Downloads
          </a>
        </li>

        <li>
          <a class="" href="/faq.html">
            FAQ
          </a>
        </li>

            </ul>
          </div>
        </div>
      </div>
    </div>

<div class="container-fluid">
<div class="row-fluid">
  <div class="span2">
    <a href='/docs/Manual/Plugins/index.html'><i class='icon-hand-up'></i></a><h3><a href='/docs/Manual/Plugins/Windows/index.html'>Windows</a></h3><div class='css-treeview'><ul class='nav nav-list'>
<li>
  <input type="checkbox" id="item-/Registry" />
  <label for="item-/Registry">
    Registry
  </label>
<ul class='nav nav-list'>
<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/GetServiceSids.html' class="tree-link">getservicesids</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/HashDump.html' class="tree-link">hashdump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/HiveDump.html' class="tree-link">hivedump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/Hives.html' class="tree-link">hives</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/LSADump.html' class="tree-link">lsadump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/PrintKey.html' class="tree-link">printkey</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/RegDump.html' class="tree-link">regdump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/UserAssist.html' class="tree-link">userassist</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Registry/Users.html' class="tree-link">users</a>
</ul></li>
<li>
  <input type="checkbox" id="item-/Win32_GUI" />
  <label for="item-/Win32_GUI">
    Win32_GUI
  </label>
<ul class='nav nav-list'>
<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/Atoms.html' class="tree-link">atoms</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/AtomScan.html' class="tree-link">atomscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/SetProcessContext.html' class="tree-link">cc</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/WinDesktops.html' class="tree-link">desktops</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/WinEventHooks.html' class="tree-link">eventhooks</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/Gahti.html' class="tree-link">gahti</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/WinMessageHooks.html' class="tree-link">messagehooks</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/Sessions.html' class="tree-link">sessions</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/UserHandles.html' class="tree-link">userhandles</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Win32_GUI/WindowsStations.html' class="tree-link">windows_stations</a>
</ul></li>
<li>
   <a href='/docs/Manual/Plugins/Windows/Callbacks.html' class="tree-link">callbacks</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/CertVadScan.html' class="tree-link">cert_vad_scan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/CertScan.html' class="tree-link">certscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/CmdScan.html' class="tree-link">cmdscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Connections.html' class="tree-link">connections</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ConnScan.html' class="tree-link">connscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Consoles.html' class="tree-link">consoles</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/DeviceTree.html' class="tree-link">devicetree</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Disassemble.html' class="tree-link">dis</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/DLLDump.html' class="tree-link">dlldump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinDllList.html' class="tree-link">dlllist</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/DriverIrp.html' class="tree-link">driverirp</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/DriverScan.html' class="tree-link">driverscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/DTBScan.html' class="tree-link">dtbscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/DTBScan2.html' class="tree-link">dtbscan2</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/EvtLogs.html' class="tree-link">evtlogs</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/FileScan.html' class="tree-link">filescan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinFindDTB.html' class="tree-link">find_dtb</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Handles.html' class="tree-link">handles</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ImageInfo.html' class="tree-link">imageinfo</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ImpScan.html' class="tree-link">impscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/KDBGScan.html' class="tree-link">kdbgscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/KPCR.html' class="tree-link">kpcr</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/LdrModules.html' class="tree-link">ldrmodules</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Malfind.html' class="tree-link">malfind</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinMemDump.html' class="tree-link">memdump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinMemMap.html' class="tree-link">memmap</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ModDump.html' class="tree-link">moddump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ModScan.html' class="tree-link">modscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Modules.html' class="tree-link">modules</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/MutantScan.html' class="tree-link">mutantscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinNetscan.html' class="tree-link">netscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Netstat.html' class="tree-link">netstat</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinNetstat.html' class="tree-link">netstat</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ObjectTree.html' class="tree-link">object_tree</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Objects.html' class="tree-link">object_types</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinPas2Vas.html' class="tree-link">pas2vas</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PEDump.html' class="tree-link">pedump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PEInfo.html' class="tree-link">peinfo</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PFNInfo.html' class="tree-link">pfn</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinPhysicalMap.html' class="tree-link">phys_map</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PoolTracker.html' class="tree-link">pool_tracker</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Pools.html' class="tree-link">pools</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ProcExeDump.html' class="tree-link">procdump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ProcInfo.html' class="tree-link">procinfo</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PSAux.html' class="tree-link">psaux</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinPsList.html' class="tree-link">pslist</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PSScan.html' class="tree-link">psscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PSTree.html' class="tree-link">pstree</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PsXview.html' class="tree-link">psxview</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PTE.html' class="tree-link">pte</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/PtoV.html' class="tree-link">ptov</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Raw2Dump.html' class="tree-link">raw2dmp</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Sockets.html' class="tree-link">sockets</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinSSDT.html' class="tree-link">ssdt</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/SvcScan.html' class="tree-link">svcscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/SymLinkScan.html' class="tree-link">symlinkscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ThrdScan.html' class="tree-link">thrdscan</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Threads.html' class="tree-link">threads</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/Timers.html' class="tree-link">timers</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/GetSIDs.html' class="tree-link">tokens</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/UnloadedModules.html' class="tree-link">unloaded_modules</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/VAD.html' class="tree-link">vad</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/VADDump.html' class="tree-link">vaddump</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/VADInfo.html' class="tree-link">vadinfo</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/VADTree.html' class="tree-link">vadtree</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/VADWalk.html' class="tree-link">vadwalk</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/ModVersions.html' class="tree-link">version_modules</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/WinVirtualMap.html' class="tree-link">virt_map</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/VtoP.html' class="tree-link">vtop</a>

<li>
   <a href='/docs/Manual/Plugins/Windows/YaraScan.html' class="tree-link">yarascan</a>
</ul></div>
  </div>

  <div class="span8">
    
<h1>cmdscan</h1>

<div class="abstract">
<p>Extract command history by scanning for _COMMAND_HISTORY</p>
</div>


<h3>Plugin Arguments</h3>
<table class='table table-striped table-bordered table-hover'>
<tbody>
<tr><td>max_history</td><td>Value of history buffer size. See HKEY_CURRENT_USER\Console\HistoryBufferSize for default.</td></tr>
</tbody>
</table>



<a href="/epydocs/rekall.plugins.windows.malware.cmdhistory.CmdScan-class.html">View Source</a>


<p>The cmdscan plugin searches the memory of csrss.exe on XP/2003/Vista/2008 and
conhost.exe on Windows 7 for commands that attackers entered through a console
shell (cmd.exe). This is one of the most powerful commands you can use to gain
visibility into an attackers actions on a victim system, whether they opened
cmd.exe through an RDP session or proxied input/output to a command shell from a
networked backdoor.</p>
<p>This plugin finds structures known as <strong>COMMAND_HISTORY</strong> by looking for a known
constant value (<strong>MaxHistory</strong>) and then applying sanity checks. It is important
to note that the <strong>MaxHistory</strong> value can be changed by right clicking in the
top left of a cmd.exe window and going to Properties. The value can also be
changed for all consoles opened by a given user by modifying the registry key
HKCU\Console\HistoryBufferSize. The default is 50 on Windows systems, meaning
the most recent 50 commands are saved. You can tweak it if needed by using the
&ndash;max_history=NUMBER parameter.</p>
<p>The structures used by this plugin are not public (i.e. Microsoft does not
produce PDBs for them), thus they&rsquo;re not available in WinDBG or any other
forensic framework. They were reverse engineered by Michael Ligh from the
conhost.exe and winsrv.dll binaries.</p>
<p>In addition to the commands entered into a shell, this plugin shows:</p>
<ul>
<li>
<p>The name of the console host process (csrss.exe or conhost.exe)</p>
</li>
<li>
<p>The name of the application using the console (whatever process is using cmd.exe)</p>
</li>
<li>
<p>The location of the command history buffers, including the current buffer count, last added command, and last displayed command</p>
</li>
<li>
<p>The application process handle</p>
</li>
</ul>
<p>Due to the scanning technique this plugin uses, it has the capability to find
commands from both active and closed consoles.</p>
<h3>Notes</h3>
<p>This plugin is pretty fragile since it relies on reversed structures in
undocumented code. We are working on improving the situation here but there is a
moderate chance that it will produce no results or garbage results.</p>
<h3>Sample Output</h3>
<p>The following showing an operator using the winpmem acquisition tool to analyse
the live memory of a Windows 7 machine.</p>
<div class="highlight"><pre><span class="n">win7</span><span class="p">.</span><span class="n">elf</span> <span class="mi">22</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">39</span><span class="o">&gt;</span> <span class="n">cmdscan</span>
<span class="o">-----------------&gt;</span> <span class="n">cmdscan</span><span class="p">()</span>
<span class="o">**************************************************</span>
<span class="nl">CommandProcess:</span> <span class="n">conhost</span><span class="p">.</span><span class="n">exe</span> <span class="n">Pid</span><span class="o">:</span> <span class="mi">2652</span>
<span class="nl">CommandHistory:</span> <span class="mh">0x7ea40</span> <span class="n">Application</span><span class="o">:</span> <span class="n">cmd</span><span class="p">.</span><span class="n">exe</span> <span class="n">Flags</span><span class="o">:</span> <span class="n">Allocated</span><span class="p">,</span> <span class="n">Reset</span>
<span class="nl">CommandCount:</span> <span class="mi">3</span> <span class="n">LastAdded</span><span class="o">:</span> <span class="mi">2</span> <span class="n">LastDisplayed</span><span class="o">:</span> <span class="mi">2</span>
<span class="nl">FirstCommand:</span> <span class="mi">0</span> <span class="n">CommandCountMax</span><span class="o">:</span> <span class="mi">50</span>
<span class="nl">ProcessHandle:</span> <span class="mh">0x5c</span>
<span class="n">Cmd</span>    <span class="n">Address</span>     <span class="n">Text</span>
<span class="o">---</span> <span class="o">--------------</span> <span class="o">--------------------------------------------------</span>
  <span class="mi">0</span> <span class="mh">0x00000005ea70</span> <span class="n">cd</span> <span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">a</span><span class="err">\</span><span class="n">Desktop</span>
  <span class="mi">1</span> <span class="mh">0x00000005b920</span> <span class="n">winpmem_1</span><span class="mf">.1</span><span class="o">-</span><span class="n">write</span><span class="p">.</span><span class="n">exe</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">l</span>
  <span class="mi">2</span> <span class="mh">0x0000000b3e70</span> <span class="n">vol</span><span class="p">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">profile</span> <span class="n">Win7SP1x64</span> <span class="o">--</span><span class="n">file</span> <span class="err">\\</span><span class="p">.</span><span class="err">\</span><span class="n">pmem</span>
 <span class="mi">15</span> <span class="mh">0x000000040158</span>
 <span class="mi">16</span> <span class="mh">0x00000007d3b0</span>

<span class="o">**************************************************</span>
<span class="nl">CommandProcess:</span> <span class="n">conhost</span><span class="p">.</span><span class="n">exe</span> <span class="n">Pid</span><span class="o">:</span> <span class="mi">2652</span>
<span class="nl">CommandHistory:</span> <span class="mh">0xb40c0</span> <span class="n">Application</span><span class="o">:</span> <span class="n">vol</span><span class="p">.</span><span class="n">exe</span> <span class="n">Flags</span><span class="o">:</span> <span class="n">Allocated</span>
<span class="nl">CommandCount:</span> <span class="mi">0</span> <span class="n">LastAdded</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="n">LastDisplayed</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span>
<span class="nl">FirstCommand:</span> <span class="mi">0</span> <span class="n">CommandCountMax</span><span class="o">:</span> <span class="mi">50</span>
<span class="nl">ProcessHandle:</span> <span class="mh">0xd4</span>
<span class="n">Cmd</span>    <span class="n">Address</span>     <span class="n">Text</span>
<span class="o">---</span> <span class="o">--------------</span> <span class="o">--------------------------------------------------</span>
  <span class="mi">0</span> <span class="mh">0x0000001f77e0</span>
  <span class="mi">3</span> <span class="mh">0x000000060ef0</span>
  <span class="mi">5</span> <span class="mh">0x0000001f77e0</span>
  <span class="mi">8</span> <span class="mh">0x000000060ef0</span>
 <span class="mi">10</span> <span class="mh">0x0000001f77e0</span>
 <span class="mi">13</span> <span class="mh">0x0000ffd96238</span>
 <span class="mi">14</span> <span class="mh">0x00000007ec20</span>
 <span class="mi">15</span> <span class="mh">0x0000001f7720</span>
 <span class="mi">23</span> <span class="mh">0x0000000610a0</span>
 <span class="mi">24</span> <span class="mh">0x0000000974e0</span>
<span class="o">**************************************************</span>
<span class="nl">CommandProcess:</span> <span class="n">conhost</span><span class="p">.</span><span class="n">exe</span> <span class="n">Pid</span><span class="o">:</span> <span class="mi">2652</span>
<span class="nl">CommandHistory:</span> <span class="mh">0xb4410</span> <span class="n">Application</span><span class="o">:</span> <span class="n">vol</span><span class="p">.</span><span class="n">exe</span> <span class="n">Flags</span><span class="o">:</span> <span class="n">Allocated</span>
<span class="nl">CommandCount:</span> <span class="mi">0</span> <span class="n">LastAdded</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="n">LastDisplayed</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span>
<span class="nl">FirstCommand:</span> <span class="mi">0</span> <span class="n">CommandCountMax</span><span class="o">:</span> <span class="mi">50</span>
<span class="nl">ProcessHandle:</span> <span class="mh">0xd8</span>
<span class="n">Cmd</span>    <span class="n">Address</span>     <span class="n">Text</span>
<span class="o">---</span> <span class="o">--------------</span> <span class="o">--------------------------------------------------</span>
</pre></div>

  </div>
  <div class="span2 sidebar">
    <img src="/img/Rekall.png"></img>

  </div>
</div>
</div>
  </body>
</html>

